<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8" />
        <title>ws2812</title>
        <style>
			body {
				text-align: center;
				font-family: 'Orbitron', sans-serif;
			}

			.button {
				background-color: black;
				border: none;
				color: #ffc000;
				padding: 15px 32px;
				text-align: center;
				text-decoration: none;
				display: inline-block;
				margin: 4px 2px;
				cursor: pointer;
				font-size: 24px;
			}

			#connected, #disconnectButton {
				display: none;
				font-size: 24px;
			}

			#pinNumber {
				font-size: 24px;
				width: 50px;
			}
		</style>
        <link
            href="https://fonts.googleapis.com/css?family=Orbitron"
            rel="stylesheet"
        />
    </head>
    <body>
        <h1>ws2812</h1>
        <input class="button" type="button" id="connectButton" value="Connect" />
        <input class="button" type="button" id="disconnectButton" value="Disconnect" />
	<br/>
        <div id="connected">
            <input id="colourPicker1" type="color"/>
            <input id="ledStart" type="number" value="0" style="width: 5ch;"/>
            <input id="ledEnd" type="number" value="36" style="width: 5ch;"/>
	    <input id="colourPicker2" type="color"/>
	    <br/>
	    <label>move speed</label>
	    <br/>
	    <input type="range" id="speed" name="speed" min="0" max="100" value="10">
	    <br/>
	    <input class="button" type="button" id="colourButton" value="Send Colour" />
        </div>
  
	<script>
		const connectButton = document.getElementById('connectButton');
		const disconnectButton = document.getElementById('disconnectButton');
		const colourPicker1 = document.getElementById('colourPicker1');
		const ledStart = document.getElementById('ledStart');
		const ledEnd = document.getElementById('ledEnd');
		const colourPicker2 = document.getElementById('colourPicker2');
		const colourButton = document.getElementById('colourButton');
		const speed = document.getElementById('speed');
		const connect = document.getElementById('connect');
		const deviceHeartbeat = document.getElementById('deviceHeartbeat');
		const primaryServiceUuid = 0xfff0;
		const receiveCharUuid = 0xfff1;
		const sendCharUuid = 0xfff2;
		let device, sendCharacteristic, receiveCharacteristic;
		
		connectButton.onclick = async () => {
			device = await navigator.bluetooth.requestDevice({
				filters: [{
					services: [primaryServiceUuid]
				}]
			});
			const server = await device.gatt.connect();
			const service = await server.getPrimaryService(primaryServiceUuid);
			receiveCharacteristic = await service.getCharacteristic(receiveCharUuid);
			sendCharacteristic = await service.getCharacteristic(sendCharUuid);
			device.ongattserverdisconnected = disconnect;
			connected.style.display = 'block';
			connectButton.style.display = 'none';
			disconnectButton.style.display = 'initial';
		};
		const disconnect = () => {
			device = null;
			receiveCharacteristic = null;
			sendCharacteristic = null;
			connected.style.display = 'none';
			connectButton.style.display = 'initial';
			disconnectButton.style.display = 'none';
		};
		disconnectButton.onclick = async () => {
			await device.gatt.disconnect();
			disconnect();
		};
		const hexToRgb = (hex1, hex2) => {
			const r1 = parseInt(hex1.substring(1, 3), 16);
			const g1 = parseInt(hex1.substring(3, 5), 16);
			const b1 = parseInt(hex1.substring(5, 7), 16);
			const s = ledStart.value;
			const e = ledEnd.value;
			const r2 = parseInt(hex2.substring(1, 3), 16);
			const g2 = parseInt(hex2.substring(3, 5), 16);
			const b2 = parseInt(hex2.substring(5, 7), 16);
			const myspeed = speed.value;
			return [r1, g1, b1, s, e, r2, g2, b2, myspeed];
		};
		colourButton.onclick = async () => {
			const data = new Uint8Array(hexToRgb(colourPicker1.value, colourPicker2.value));
			sendCharacteristic.writeValue(data);
		};
	</script>
</body>
</html>
